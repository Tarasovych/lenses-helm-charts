suite: enable SSL and check the changes in deployment, configmap and secret
templates:
  - deployment.yaml
  - secrets.yaml
tests:
  - it: should work
    values:
      - values/with-ssl.yaml
    asserts:
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_KAFKA_BROKERS
            value: SSL://kafka:9093
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_KAFKA_SETTINGS_CLIENT_SECURITY_PROTOCOL
            value: SSL
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_KAFKA_SETTINGS_CLIENT_SSL_TRUSTSTORE_LOCATION
            value: /mnt/secrets/client.truststore.jks
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_KAFKA_SETTINGS_CLIENT_SSL_KEYSTORE_LOCATION
            value: /mnt/secrets/client.keystore.jks
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_KAFKA_SETTINGS_CLIENT_SSL_TRUSTSTORE_PASSWORD
            valueFrom:
              secretKeyRef:
                key: client.truststore.password
                name: RELEASE-NAME
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_KAFKA_SETTINGS_CLIENT_SSL_KEYSTORE_PASSWORD
            valueFrom:
              secretKeyRef:
                key: client.keystore.password
                name: RELEASE-NAME
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_KAFKA_SETTINGS_CLIENT_SSL_KEY_PASSWORD
            valueFrom:
              secretKeyRef:
                key: client.key.password
                name: RELEASE-NAME

      - template: secrets.yaml
        equal:
          path: data.client\.keystore\.jks
          value: bar
      - template: secrets.yaml
        equal:
          path: data.client\.truststore\.jks
          value: foo
      - template: secrets.yaml
        equal:
          path: stringData.client\.key\.password
          value: foobarPass
      - template: secrets.yaml
        equal:
          path: stringData.client\.keystore\.password
          value: barPass
      - template: secrets.yaml
        equal:
          path: stringData.client\.truststore\.password
          value: fooPass
