suite: with Schema Registries
templates:
  - deployment.yaml
tests:
  - it: should work with schema registries enabled and use sample configuration
    set:
      lenses:
        schemaRegistries:
          enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_SCHEMA_REGISTRY_URLS
            value: |-
              [
                {
                  url: "http://schema-registry:8081"
                }
              ]
  - it: should work with schema registry with one host
    set:
      lenses:
        schemaRegistries:
          enabled: true
          hosts:
            - host: schema-registry-1.example.com
              protocol: http
              port: 8082
              path:
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_SCHEMA_REGISTRY_URLS
            value: |-
              [
                {
                  url: "http://schema-registry-1.example.com:8082"
                }
              ]
  - it: should work with schema registry with two hosts
    set:
      lenses:
        schemaRegistries:
          enabled: true
          hosts:
            - host: schema-registry-1.example.com
              protocol: http
              port: 8082
            - host: schema-registry-2.example.com
              protocol: http
              port: 8083
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_SCHEMA_REGISTRY_URLS
            value: |-
              [
                {
                  url: "http://schema-registry-1.example.com:8082"
                },
                {
                  url: "http://schema-registry-2.example.com:8083"
                }
              ]
  - it: should work with schema registry with two hosts and both having path
    set:
      lenses:
        schemaRegistries:
          enabled: true
          hosts:
            - host: schema-registry-1.example.com
              protocol: http
              port: 8082
              path: /foo
            - host: schema-registry-2.example.com
              protocol: http
              port: 8083
              path: /bar
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_SCHEMA_REGISTRY_URLS
            value: |-
              [
                {
                  url: "http://schema-registry-1.example.com:8082/foo"
                },
                {
                  url: "http://schema-registry-2.example.com:8083/bar"
                }
              ]
  - it: should work with schema registry with two hosts, both having path and JMX metrics
    set:
      lenses:
        schemaRegistries:
          enabled: true
          hosts:
            - host: schema-registry-1.example.com
              protocol: http
              port: 8082
              path: /foo
              metrics:
                type: "JMX"
                port: 9102
            - host: schema-registry-2.example.com
              protocol: http
              port: 8083
              path: /bar
              metrics:
                type: "JMX"
                port: 9103
                protocol:
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_SCHEMA_REGISTRY_URLS
            value: |-
              [
                {
                  url: "http://schema-registry-1.example.com:8082/foo",
                  metrics: {
                    url: "schema-registry-1.example.com:9102",
                    type: "JMX",
                    ssl: false
                  }
                },
                {
                  url: "http://schema-registry-2.example.com:8083/bar",
                  metrics: {
                    url: "schema-registry-2.example.com:9103",
                    type: "JMX",
                    ssl: false
                  }
                }
              ]
  - it: should work with schema registry with 4 hosts having Jolokia metrics with protocol overrides
    set:
      lenses:
        schemaRegistries:
          enabled: true
          hosts:
            - host: schema-registry-1.example.com
              protocol: http
              port: 8082
              metrics:
                type: "JOLOKIA"
                port: 9102
            - host: schema-registry-2.example.com
              protocol: https
              port: 8083
              metrics:
                type: "JOLOKIA"
                port: 9103
            - host: schema-registry-3.example.com
              protocol: http
              port: 8083
              metrics:
                type: "JOLOKIA"
                port: 9103
                protocol: https
            - host: schema-registry-4.example.com
              protocol: https
              port: 8083
              metrics:
                type: "JOLOKIA"
                port: 9103
                protocol: http
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_SCHEMA_REGISTRY_URLS
            value: |-
              [
                {
                  url: "http://schema-registry-1.example.com:8082",
                  metrics: {
                    url: "http://schema-registry-1.example.com:9102",
                    type: "JOLOKIA",
                    ssl: false
                  }
                },
                {
                  url: "https://schema-registry-2.example.com:8083",
                  metrics: {
                    url: "https://schema-registry-2.example.com:9103",
                    type: "JOLOKIA",
                    ssl: false
                  }
                },
                {
                  url: "http://schema-registry-3.example.com:8083",
                  metrics: {
                    url: "https://schema-registry-3.example.com:9103",
                    type: "JOLOKIA",
                    ssl: false
                  }
                },
                {
                  url: "https://schema-registry-4.example.com:8083",
                  metrics: {
                    url: "http://schema-registry-4.example.com:9103",
                    type: "JOLOKIA",
                    ssl: false
                  }
                }
              ]
  - it: should work with schema registry with two hosts having JMX metrics configuration with creds and ssl
    set:
      lenses:
        schemaRegistries:
          enabled: true
          hosts:
            - host: schema-registry-1.example.com
              protocol: http
              port: 8082
              path: /foo
              metrics:
                type: "JMX"
                port: 9102
                username: foo
                password: bar
                ssl: false
            - host: schema-registry-2.example.com
              protocol: http
              port: 8083
              path: /bar
              metrics:
                type: "JMX"
                port: 9103
                protocol:
                username: foo2
                password: bar2
                ssl: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_SCHEMA_REGISTRY_URLS
            value: |-
              [
                {
                  url: "http://schema-registry-1.example.com:8082/foo",
                  metrics: {
                    url: "schema-registry-1.example.com:9102",
                    type: "JMX",
                    ssl: false,
                    user: "foo",
                    password: "bar"
                  }
                },
                {
                  url: "http://schema-registry-2.example.com:8083/bar",
                  metrics: {
                    url: "schema-registry-2.example.com:9103",
                    type: "JMX",
                    ssl: true,
                    user: "foo2",
                    password: "bar2"
                  }
                }
              ]