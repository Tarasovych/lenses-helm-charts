suite: enable provision and check the changes in deployment and secret
templates:
  - deployment.yaml
  - provision-secrets.yaml
  - secrets.yaml
tests:
  - it: should work with provision disabled (default mode)
    # set:
    #   lenses:
    #     provision:
    #       enabled: false
    asserts:
      - template: provision-secrets.yaml
        hasDocuments:
          count: 0
      - template: deployment.yaml
        notContains:
          path: spec.template.spec.volumes
          content:
            name: provision-secrets
            secret:
              secretName: RELEASE-NAME-provision
  - it: should work with provision yaml set
    set:
      lenses:
        provision:
          enabled: true
          yaml:
            key: this is valid yaml
            values:
              - I can have an array
              - with 2 elelments
            moreValues: |-
              and a multiline
              text field
    asserts:
      - template: provision-secrets.yaml
        equal:
          path: stringData.provision\.yaml
          value: |-
              key: this is valid yaml
              moreValues: |-
                and a multiline
                text field
              values:
              - I can have an array
              - with 2 elelments
      - template: deployment.yaml
        contains:
          path: spec.template.spec.volumes
          content:
            name: provision-secrets
            secret:
              secretName: RELEASE-NAME-provision
  - it: should work with provision secrets set
    set:
      lenses:
        provision:
          enabled: true
          yaml:
            goo: loo
          secrets:
            stringData:
              foo1: bar1
              foo2: bar2
              foo3: bar3
            data:
              foo: YmFy
    asserts:
      - template: provision-secrets.yaml
        hasDocuments:
          count: 1
      - template: provision-secrets.yaml
        equal:
          path: stringData.foo1
          value: bar1
      - template: provision-secrets.yaml
        equal:
          path: data.foo
          value: YmFy

      - template: deployment.yaml
        contains:
          path: spec.template.spec.volumes
          content:
            name: provision-secrets
            secret:
              secretName: RELEASE-NAME-provision
