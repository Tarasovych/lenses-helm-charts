suite: enable metrics and check the changes in deployment, configmap and secret
templates:
  - deployment.yaml
tests:
  - it: should work with default.port
    set:
      lenses:
        kafka:
          metrics:
            enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_KAFKA_METRICS
            value: |-
              {
                type: "JMX",
                ssl: false,
                default.port: 9102
              }
  - it: should work with multiple ports
    set:
      lenses:
        kafka:
          metrics:
            enabled: true
            ports:
              - id: foo
                port: 9103
                host: example1
              - id: bar
                port: 9104
                host: example2
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_KAFKA_METRICS
            value: |-
              {
                type: "JMX",
                ssl: false,
                port: [
                  {
                    host: "example1",
                    id: "foo",
                    port: "9103",
                  },
                  {
                    host: "example2",
                    id: "bar",
                    port: "9104",
                  }
                ]
              }
  - it: should work with multiple ports and type AWS
    set:
      lenses:
        kafka:
          metrics:
            enabled: true
            type: AWS
            ports:
              - id: foo
                url: example1:9103
              - id: bar
                url: example2:9104
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_KAFKA_METRICS
            value: |-
              {
                type: "AWS",
                ssl: false,
                port: [
                  {
                    id: "foo",
                    url: "example1:9103",
                  },
                  {
                    id: "bar",
                    url: "example2:9104",
                  }
                ]
              }
  - it: should work with zookeeper metrics
    set:
      lenses:
        zookeepers:
          enabled: true
          hosts:
            - host: zookeeper1
              port: 2181
              metrics:
                type: "JMX"
                port: 9102
                username: foo
                password: bar
                ssl: true
            - host: zookeeper2
              port: 2181
              metrics:
                type: "JMX"
                port: 9103
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_ZOOKEEPER_HOSTS
            value: |-
              [
                {
                  url: "zookeeper1:2181",
                  metrics: {
                    url: "zookeeper1:9102",
                    type: "JMX",
                    ssl: true,user: "foo",password: "bar",
                  }
                },
                {
                  url: "zookeeper2:2181",
                  metrics: {
                    url: "zookeeper2:9103",
                    type: "JMX",
                    ssl: false,
                  }
                }
              ]
  - it: should work with zookeeper metrics with url
    set:
      lenses:
        zookeepers:
          enabled: true
          hosts:
            - host: zookeeper1
              port: 2181
              metrics:
                url: metrics.zookeeper1:9112
                type: "JMX"
                port: 9102
                username: foo
                password: bar
                ssl: true
            - host: zookeeper2
              port: 2181
              metrics:
                type: "JMX"
                port: 9103
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_ZOOKEEPER_HOSTS
            value: |-
              [
                {
                  url: "zookeeper1:2181",
                  metrics: {
                    url: "metrics.zookeeper1:9112",
                    type: "JMX",
                    ssl: true,user: "foo",password: "bar",
                  }
                },
                {
                  url: "zookeeper2:2181",
                  metrics: {
                    url: "zookeeper2:9103",
                    type: "JMX",
                    ssl: false,
                  }
                }
              ]
  - it: should work with schema-registry metrics
    set:
      lenses:
        schemaRegistries:
          enabled: true
          hosts:
            - host: schema-registry1
              port: 8081
              metrics:
                type: "JMX"
                port: 9102
                username: foo
                password: bar
                ssl: true
            - host: schema-registry2
              port: 8081
              metrics:
                type: "JMX"
                port: 9103
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_SCHEMA_REGISTRY_URLS
            value: |-
              [
                {
                  url: "http://schema-registry1:8081",
                  metrics: {
                    url: "schema-registry1:9102",
                    type: "JMX",
                    ssl: true,
                    user: "foo",
                    password: "bar"
                  }
                },
                {
                  url: "http://schema-registry2:8081",
                  metrics: {
                    url: "schema-registry2:9103",
                    type: "JMX",
                    ssl: false
                  }
                }
              ]
  - it: should work with schema-registry metrics with url
    set:
      lenses:
        schemaRegistries:
          enabled: true
          hosts:
            - host: schema-registry1
              port: 8081
              metrics:
                url: metrics.schema-registry1:9102
                type: "JMX"
                username: foo
                password: bar
                ssl: true
            - host: schema-registry2
              port: 8081
              metrics:
                type: "JMX"
                port: 9103
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_SCHEMA_REGISTRY_URLS
            value: |-
              [
                {
                  url: "http://schema-registry1:8081",
                  metrics: {
                    url: "metrics.schema-registry1:9102",
                    type: "JMX",
                    ssl: true,
                    user: "foo",
                    password: "bar"
                  }
                },
                {
                  url: "http://schema-registry2:8081",
                  metrics: {
                    url: "schema-registry2:9103",
                    type: "JMX",
                    ssl: false
                  }
                }
              ]
  - it: should work with zk, schema-registry metrics, all with urls
    set:
      lenses:
        zookeepers:
          enabled: true
          hosts:
            - host: zookeeper1
              port: 2181
              metrics:
                url: metrics.zookeeper1:9112
                type: "JMX"
                port: 9102
                username: foo
                password: bar
                ssl: true
            - host: zookeeper2
              port: 2181
              metrics:
                type: "JMX"
                port: 9103
        schemaRegistries:
          enabled: true
          hosts:
            - host: schema-registry1
              port: 8081
              metrics:
                url: metrics.schema-registry1:9102
                type: "JMX"
                username: foo
                password: bar
                ssl: true
            - host: schema-registry2
              port: 8081
              metrics:
                type: "JMX"
                port: 9103
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_SCHEMA_REGISTRY_URLS
            value: |-
              [
                {
                  url: "http://schema-registry1:8081",
                  metrics: {
                    url: "metrics.schema-registry1:9102",
                    type: "JMX",
                    ssl: true,
                    user: "foo",
                    password: "bar"
                  }
                },
                {
                  url: "http://schema-registry2:8081",
                  metrics: {
                    url: "schema-registry2:9103",
                    type: "JMX",
                    ssl: false
                  }
                }
              ]
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LENSES_ZOOKEEPER_HOSTS
            value: |-
              [
                {
                  url: "zookeeper1:2181",
                  metrics: {
                    url: "metrics.zookeeper1:9112",
                    type: "JMX",
                    ssl: true,user: "foo",password: "bar",
                  }
                },
                {
                  url: "zookeeper2:2181",
                  metrics: {
                    url: "zookeeper2:9103",
                    type: "JMX",
                    ssl: false,
                  }
                }
              ]
